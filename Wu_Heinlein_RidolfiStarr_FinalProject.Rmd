---
output: html_document
editor_options: 
  chunk_output_type: console
---
\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup}

# Load your packages
library(tidyverse) 
library(here) 
library(cowplot)
library(lubridate) 
library(zoo)
library(trend)
library(sf)
library(mapview); mapviewOptions(fgb = FALSE) 
library(cowplot)
library(agricolae)
library(knitr)

# Set your working directory
here()

# Set your ggplot theme
mytheme <- theme_classic(base_size = 13) +
  theme(axis.text = element_text(color = "black"),
        plot.background = element_rect(fill = "white", color = NA),
        legend.position = "right")
theme_set(mytheme)

# Load your datasets
WQ_data_raw <- read.csv(here("./Raw_Data/WQ_data.txt"), header = TRUE, sep = "|",
                        colClasses = c("ProgramLocationID"="factor",
                                       "Year"="factor",
                                       "Month"="factor",
                                       "ParameterName"="factor"))

```


# Rationale and Research Questions
This study takes examines how the Miami Beach fertilizer ordinance affect 
the various parameters used to assess water quality. For context, the Miami 
Beach fertilizer ordinance prohibits the use of fertilizers containing 
nitrogen and phosphorus during the summer rainy season, and it was first 
passed and enacted in January, 2021. The ordinance is effective from May 15 
through October 31 every year. 


\newpage

# Dataset Information

```{r}
#wrangling

#Insert underscores into parameter names
levels(WQ_data_raw$ParameterName) <- c("Dissolved_O2", "NO2_NO3_Filtered", "pH", 
                                    "Salinity", "Specific_Conductivity", 
                                    "Total_Kjeldahl_Nitrogen", "Total_Nitrogen",
                                    "Total_Phosphorous", "Turbidity", 
                                    "Water_Temperature")

#pivot parameteres
WQ_parameters_raw <- WQ_data_raw %>%
  #select  columns of interest (we can add more later)
  select(SampleDate, ParameterName, ResultValue, Year, Month, ProgramLocationID,
         OriginalLatitude, OriginalLongitude) %>%
  group_by(SampleDate, Year, Month, ProgramLocationID, OriginalLatitude,
           OriginalLongitude, ParameterName) %>%
  summarise(
    mean_ResultValue = mean(ResultValue)) %>%
  #move parameters of interest into their own columns
  pivot_wider(names_from = ParameterName, values_from = mean_ResultValue) %>%
  mutate(SampleDate = ymd_hms(SampleDate),
         Group = ifelse(SampleDate < as.Date("2021-04-1"), "Pre", "Post"))


#monthly averages data frame (for time series)
WQ_monthly_data <- WQ_parameters_raw %>%
  group_by(Year, Month, Group) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-",Month)))


#Find missing observations (needed for interpolation)
dates_by_month <- as.data.frame(seq.Date(from=as.Date("2016/08/01"),
                                      to=as.Date("2024/12/01"),
                                      by="month"))
colnames(dates_by_month) <- "Date"
WQ_monthly_complete <- left_join(dates_by_month, WQ_monthly_data)


#interpolate monthly data
WQ_monthly_complete <- WQ_monthly_complete %>%
  mutate(
    Interp_Phosphorous = na.approx(Mean_Phosphorous),
    Interp_pH = na.approx(Mean_pH),
    Interp_Dissolved_O2 = na.approx(Mean_Dissolved_O2),
    Interp_Total_N = na.approx(Mean_Total_N),
    Group = ifelse(Date < as.Date("2021-04-01"), "Pre", "Post"))


#yearly numbers
yearly_averages <- WQ_parameters_raw %>%
  group_by(Year, Group) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-","01")))

yearly_averages_bysite <- WQ_parameters_raw %>%
  group_by(Year, ProgramLocationID, OriginalLatitude, OriginalLongitude) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-","01")))


#split data into pre- and post-ordinance data frames
pre_ordinance_monthly <- WQ_monthly_complete %>%
  filter(Group == "Pre")
  
post_ordinance_monthly <- WQ_monthly_complete %>%
  filter(Group == "Post")

pre_ordinance_yearly <- yearly_averages %>%
  filter(Group == "Pre")

post_ordinance_yearly <- yearly_averages %>%
  filter(Group == "Post")


#parameter summary table
Minima <- c(
  min(WQ_parameters_raw$Total_Phosphorous, na.rm=TRUE),
  min(WQ_parameters_raw$Total_Nitrogen, na.rm=TRUE),
  min(WQ_parameters_raw$Dissolved_O2, na.rm=TRUE),
  min(WQ_parameters_raw$pH, na.rm=TRUE))

Maxima <- c(
  max(WQ_parameters_raw$Total_Phosphorous, na.rm=TRUE),
  max(WQ_parameters_raw$Total_Nitrogen, na.rm=TRUE),
  max(WQ_parameters_raw$Dissolved_O2, na.rm=TRUE),
  max(WQ_parameters_raw$pH, na.rm=TRUE))

Means <- c(
  mean(WQ_parameters_raw$Total_Phosphorous, na.rm=TRUE),
  mean(WQ_parameters_raw$Total_Nitrogen, na.rm=TRUE),
  mean(WQ_parameters_raw$Dissolved_O2, na.rm=TRUE),
  mean(WQ_parameters_raw$pH, na.rm=TRUE))

SDs <- c(
  sd(WQ_parameters_raw$Total_Phosphorous, na.rm=TRUE),
  sd(WQ_parameters_raw$Total_Nitrogen, na.rm=TRUE),
  sd(WQ_parameters_raw$Dissolved_O2, na.rm=TRUE),
  sd(WQ_parameters_raw$pH, na.rm=TRUE))

parameter.summary <- data.frame(
  "Parameter" = c("Total Phosphorous", "Total Nitrogen", "Dissolved Oxygen", "pH"),
  "Units" = c("mg/L", "mg/L", "mg/L", "NA"),
  "Minimum" = Minima,
  "Maximum" = Maxima,
  "Mean" = Means,
  "Std_Deviation" = SDs)

kable(
  parameter.summary,
  align = c("l","c","r","r","r","r"),
  digits = c(1,1,5,4,2,2),
  caption = "Parameter Summary Statistics")
```

\newpage

# Exploratory Analysis 

```{r}
#Creating simple features data frame for spatial visualization 
SampleLocations_sf <- WQ_data_raw %>%
  distinct(ProgramLocationID,OriginalLongitude, OriginalLatitude, .keep_all = FALSE) %>%
  st_as_sf(
    coords = c("OriginalLongitude", "OriginalLatitude"),
    crs= 4326)

#Visualization of sample collection locations 
mapviewOptions(basemaps = "Esri.WorldImagery")

mapview(
  SampleLocations_sf,
  layer.name= "Sample Locations",
  legend= FALSE,
  col.regions="blue",
  col="yellow",
  alpa.regions= 0.5
  )
```

```{r}
#Exploring series

phosphorous.preview <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Mean_Phosphorous)) +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2) +
  labs(
    y="Dissolved Phosphorous (mg/L)",
    x="")

nitrogen.preview <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Mean_Total_N)) +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2) +
  labs(
    y="Total Nitrogen (mg/L)",
    x="")

oxygen.preview <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Mean_Dissolved_O2)) +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2) +
  labs(
    y="Dissolved Oxygen (mg/L)",
    x="")

pH.preview <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Mean_pH)) +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2) +
  labs(
    y="pH",
    x="Date")

plot_grid(phosphorous.preview, nitrogen.preview, oxygen.preview, pH.preview, nrow=4)

```
Exploratory box plots showing the distribution of parameters of interest by year
individually and as a combined plot 
```{r}

Total_Nitrogen_Distribution <- ggplot(WQ_monthly_complete,
            aes(x=as.factor(Year),y=Interp_Total_N)
            )+
  geom_boxplot()+
  xlab("Year")+
  ylab("Total Nitrogen (mg/L)")+
  theme(axis.title.x = element_blank())+
  theme(axis.text.x = element_blank())+
  theme(axis.ticks.x = element_blank())
print(Total_Nitrogen_Distribution)

Total_Phosphorous_Distribution <- ggplot(WQ_monthly_complete,
            aes(x=as.factor(Year),y=Interp_Phosphorous)
            )+
  geom_boxplot()+
  xlab("Year")+
  ylab("TotalPhosphorous (mg/L)")+
  theme(axis.title.x = element_blank())+
  theme(axis.text.x = element_blank())+
  theme(axis.ticks.x = element_blank())
print(Total_Phosphorous_Distribution)

Dissolved_O2_Distribution <- ggplot(WQ_monthly_complete,
            aes(x=as.factor(Year),y=Interp_Dissolved_O2)
            )+
  geom_boxplot()+
  xlab("Year")+
  ylab("Dissolved O2 (mg/L)")+
  theme(axis.title.x = element_blank())+
  theme(axis.text.x = element_blank())+
  theme(axis.ticks.x = element_blank())
print(Dissolved_O2_Distribution)

pH_distribution <- ggplot(WQ_monthly_complete,
            aes(x=as.factor(Year),y=Interp_pH)
            )+
  geom_boxplot()+
  xlab("Year")+
  ylab("pH")

print(pH_distribution)

CombinedDistributionPlot <- plot_grid(
  Total_Nitrogen_Distribution,
  Total_Phosphorous_Distribution,
  Dissolved_O2_Distribution,
  pH_distribution,
  ncol=1,
  align = "v"
)

print(CombinedDistributionPlot)
```


\newpage

# Analysis

```{r}
#time series

#monthly

monthly.P.ts <- ts(WQ_monthly_complete$Interp_Phosphorous, start=c(2016,8), 
                   frequency=12)
monthly.P.decomp <- stl(monthly.P.ts, s.window="periodic")
plot(monthly.P.decomp)
monthly.P.components <- as.data.frame(monthly.P.decomp$time.series[,1:3])
monthly.P.components <- mutate(monthly.P.components,
                               observed = WQ_monthly_complete$Interp_Phosphorous,
                               date = WQ_monthly_complete$Date)

monthly.N.ts <- ts(WQ_monthly_complete$Interp_Total_N, start=c(2016,8), 
                   frequency=12)
monthly.N.decomp <- stl(monthly.N.ts, s.window="periodic")
plot(monthly.N.decomp)
monthly.N.components <- as.data.frame(monthly.N.decomp$time.series[,1:3])
monthly.N.components <- mutate(monthly.N.components,
                               observed = WQ_monthly_complete$Interp_Total_N,
                               date = WQ_monthly_complete$Date)

```


```{r}
#ANOVA
yearly.P.anova <- aov(data=WQ_monthly_complete, Mean_Phosphorous ~ Year)
summary(yearly.P.anova)
TukeyHSD(yearly.P.anova)
P.HSD <- HSD.test(yearly.P.anova, "Year", group=TRUE)
P.HSD

yearly.N.anova <- aov(data=WQ_monthly_complete, Mean_Total_N ~ Year)
summary(yearly.N.anova)
TukeyHSD(yearly.N.anova)
N.HSD <- HSD.test(yearly.N.anova, "Year", group=TRUE)
N.HSD

```

## Question 1: <insert specific question here and add additional subsections for additional questions below, if needed>

## Question 2: 




\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
https://data.florida-seacar.org/programs/details/4058 
