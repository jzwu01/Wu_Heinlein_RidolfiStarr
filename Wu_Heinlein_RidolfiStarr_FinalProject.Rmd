---
output: html_document
editor_options: 
  chunk_output_type: console
---
\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup}

# Load your packages
library(tidyverse) 
library(here) 
library(cowplot)
library(lubridate) 
library(zoo)
library(trend)
library(sf)
library(mapview); mapviewOptions(fgb = FALSE) 

# Set your working directory
here()

# Set your ggplot theme
mytheme <- theme_classic(base_size = 13) +
  theme(axis.text = element_text(color = "black"),
        plot.background = element_rect(fill = "white", color = NA),
        legend.position = "right")
theme_set(mytheme)

# Load your datasets
WQ_data_raw <- read.csv(here("./Raw_Data/WQ_data.txt"), header = TRUE, sep = "|",
                        colClasses = c("ProgramLocationID"="factor",
                                       "Year"="factor",
                                       "Month"="factor",
                                       "ParameterName"="factor"))

#Insert underscores into parameter names
levels(WQ_data_raw$ParameterName) <- c("Dissolved_O2", "NO2_NO3_Filtered", "pH", 
                                    "Salinity", "Specific_Conductivity", 
                                    "Total_Kjeldahl_Nitrogen", "Total_Nitrogen",
                                    "Total_Phosphorous", "Turbidity", 
                                    "Water_Temperature")

#create wrangled data frames

#pivoted parameters
WQ_parameters_raw <- WQ_data_raw %>%
  #select  columns of interest (we can add more later)
  select(SampleDate, ParameterName, ResultValue, Year, Month, ProgramLocationID,
         OriginalLatitude, OriginalLongitude) %>%
  group_by(SampleDate, Year, Month, ProgramLocationID, OriginalLatitude,
           OriginalLongitude, ParameterName) %>%
  summarise(
    mean_ResultValue = mean(ResultValue)) %>%
  #move parameters of interest into their own columns
  pivot_wider(names_from = ParameterName, values_from = mean_ResultValue) %>%
  mutate(SampleDate = ymd_hms(SampleDate),
         Group = ifelse(SampleDate < as.Date("2021-04-1"), "Pre", "Post"))

#monthly averages data frame (for time series)
WQ_monthly_data <- WQ_parameters_raw %>%
  group_by(Year, Month, Group) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-",Month)))

#Find missing observations (needed for interpolation)
dates_by_month <- as.data.frame(seq.Date(from=as.Date("2016/08/01"),
                                      to=as.Date("2024/12/01"),
                                      by="month"))
colnames(dates_by_month) <- "Date"

WQ_monthly_complete <- left_join(dates_by_month, WQ_monthly_data)

#interpolate monthly data
WQ_monthly_complete <- WQ_monthly_complete %>%
  mutate(
    Interp_Phosphorous = na.approx(Mean_Phosphorous),
    Interp_pH = na.approx(Mean_pH),
    Interp_Dissolved_O2 = na.approx(Mean_Dissolved_O2),
    Interp_Total_N = na.approx(Mean_Total_N),
    Group = ifelse(Date < as.Date("2021-04-01"), "Pre", "Post"))



#yearly numbers

yearly_averages <- WQ_parameters_raw %>%
  group_by(Year, Group) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-","01")))

yearly_averages_bysite <- WQ_parameters_raw %>%
  group_by(Year, ProgramLocationID, OriginalLatitude, OriginalLongitude) %>%
  summarise(
    Mean_Phosphorous = mean(Total_Phosphorous, na.rm=TRUE),
    Mean_pH = mean(pH, na.rm=TRUE),
    Mean_Dissolved_O2 = mean(Dissolved_O2, na.rm=TRUE),
    Mean_Total_N = mean(Total_Nitrogen, na.rm=TRUE)) %>%
  mutate(Date = ym(paste0(Year,"-","01")))


#split data into pre- and post-ordinance data frames
pre_ordinance_monthly <- WQ_monthly_complete %>%
  filter(Group == "Pre")
  
post_ordinance_monthly <- WQ_monthly_complete %>%
  filter(Group == "Post")

pre_ordinance_yearly <- yearly_averages %>%
  filter(Group == "Pre")

post_ordinance_yearly <- yearly_averages %>%
  filter(Group == "Post")


#Preview of trends over time...just exploring
#Note the missing data
#Vertical line represents Miami-Date County summer fertilizer ordinance

#monthly data
#phosphorous
phosphorous.plot <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Interp_Phosphorous), color="red") +
  geom_line(aes(x=Date, y=Mean_Phosphorous)) +
  geom_smooth(aes(x=Date, y=Interp_Phosphorous), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
print(phosphorous.plot)


#nitrogen
nitrogen.plot <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Interp_Total_N), color="red") +
  geom_line(aes(x=Date, y=Mean_Total_N)) +
  geom_smooth(aes(x=Date, y=Interp_Total_N), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
nitrogen.plot


#dissolved oxygen
oxygen.plot <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Interp_Dissolved_O2), color="red") +
  geom_line(aes(x=Date, y=Mean_Dissolved_O2)) +
  geom_smooth(aes(x=Date, y=Interp_Dissolved_O2), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
oxygen.plot

#pH
ph.plot <- ggplot(WQ_monthly_complete) +
  geom_line(aes(x=Date, y=Interp_pH), color="red") +
  geom_line(aes(x=Date, y=Mean_pH)) +
  geom_smooth(aes(x=Date, y=Interp_pH), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
ph.plot



#previewing pre- & post-ordinance trends

#phosphorous
P_pre_plot <- ggplot(pre_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_Phosphorous), color="red") +
  geom_line(aes(x=Date, y=Mean_Phosphorous)) +
  geom_smooth(aes(x=Date, y=Interp_Phosphorous), method="lm")
P_pre_plot

P_post_plot <- ggplot(post_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_Phosphorous), color="red") +
  geom_line(aes(x=Date, y=Mean_Phosphorous)) +
  geom_smooth(aes(x=Date, y=Interp_Phosphorous), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
P_post_plot

plot_grid(P_pre_plot, P_post_plot, ncol = 2)


#nitrogen
N_pre_plot <- ggplot(pre_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_Total_N), color="red") +
  geom_line(aes(x=Date, y=Mean_Total_N)) +
  geom_smooth(aes(x=Date, y=Interp_Total_N), method="lm")
N_pre_plot

N_post_plot <- ggplot(post_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_Total_N), color="red") +
  geom_line(aes(x=Date, y=Mean_Total_N)) +
  geom_smooth(aes(x=Date, y=Interp_Total_N), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
N_post_plot

plot_grid(N_pre_plot, N_post_plot, ncol = 2)


#dissolved oxygen
O_pre_plot <- ggplot(pre_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_Dissolved_O2), color="red") +
  geom_line(aes(x=Date, y=Mean_Dissolved_O2)) +
  geom_smooth(aes(x=Date, y=Interp_Dissolved_O2), method="lm")
O_pre_plot

O_post_plot <- ggplot(post_ordinance_monthly) +
geom_line(aes(x=Date, y=Interp_Dissolved_O2), color="red") +
  geom_line(aes(x=Date, y=Mean_Dissolved_O2)) +
  geom_smooth(aes(x=Date, y=Interp_Dissolved_O2), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
O_post_plot

plot_grid(O_pre_plot, O_post_plot, ncol = 2)


#pH
pH_pre_plot <- ggplot(pre_ordinance_monthly) +
  geom_line(aes(x=Date, y=Interp_pH), color="red") +
  geom_line(aes(x=Date, y=Mean_pH)) +
  geom_smooth(aes(x=Date, y=Interp_pH), method="lm")
pH_pre_plot

pH_post_plot <- ggplot(post_ordinance_monthly) +
geom_line(aes(x=Date, y=Interp_pH), color="red") +
  geom_line(aes(x=Date, y=Mean_pH)) +
  geom_smooth(aes(x=Date, y=Interp_pH), method="lm") +
  geom_vline(xintercept = as.Date("2021-04-01"), lty = 2)
pH_post_plot

plot_grid(pH_pre_plot, pH_post_plot, ncol = 2)
```


# Rationale and Research Questions
This study takes examines how the Miami Beach fertilizer ordinance affect 
the various parameters used to assess water quality. For context, the Miami 
Beach fertilizer ordinance prohibits the use of fertilizers containing 
nitrogen and phosphorus during the summer rainy season, and it was first 
passed and enacted in January, 2021. The ordinance is effective from May 15 
through October 31 every year. 


\newpage

# Dataset Information



\newpage

# Exploratory Analysis 

```{r}
#Creating simple features data frame for spatial visualization 
SampleLocations_sf <- WQ_data_raw %>%
  distinct(ProgramLocationID,OriginalLongitude, OriginalLatitude, .keep_all = FALSE) %>%
  st_as_sf(
    coords = c("OriginalLongitude", "OriginalLatitude"),
    crs= 4326)

#Visualization of sample collection locations 
mapviewOptions(basemaps = "Esri.WorldImagery")

mapview(
  SampleLocations_sf,
  layer.name= "Sample Locations",
  legend= FALSE,
  col.regions="blue",
  col="yellow",
  alpa.regions= 0.5
  )
```


\newpage

# Analysis



## Question 1: <insert specific question here and add additional subsections for additional questions below, if needed>

## Question 2: 




\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
https://data.florida-seacar.org/programs/details/4058 
